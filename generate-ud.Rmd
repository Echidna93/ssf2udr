---
title: "generate-uds"
output: html_document
date: "2025-05-14"
---
```{r}
library(doParallel)
library(foreach)
```

```{r}
checkTrackUD <- function(realizations, nrow, ncol){
  ud <- matrix(0, nrow = nrow, ncol = ncol)
  cell_counts <- realizations[,.N,  by = .(y.proj, x.proj)]
   ud[cbind(cell_counts$y.proj, cell_counts$x.proj)] <- cell_counts$N
  return(ud)
}

```
```{r}
# create and register worker nodes
cl <- parallel::makeCluster(3)
registerDoParallel(cl)
nrow <- 100
ncol <- 100
```

```{r generate UDs}
# get base path
basePath <- "./data/output/domain-100-by-100"
# get folder names in base path
#folders <- list.files(path = basePath, recursive = FALSE)

folders <- c("test-3-6")
nfolders <- length(folders)
# step thru each folder name
for (f in seq_len(nfolders)){
  library(terra)
  library(raster)
  library(data.table)# for ncell function
  # extract parameters from folder name
  # n.b., id = simIter - theta*10 - smoothingFactor - movePen*100
  folder <- folders[f]
  idString <- strsplit(x = folder, split =  "-")[[1]]
  simIter <- idString[1] # simIter
  theta <- as.numeric(idString[2]) / 10 # habitat preference
  smoothingFactor <- as.numeric(idString[3]) # rho
 # movePen <- as.numeric(idString[4]) / 100 # mu 
  # read in data
  realizations <- data.table::fread(paste0(basePath,"/", folder, "/", "traj"),header=TRUE, sep=",") #ud 
  ud <- checkTrackUD(realizations = realizations, nrow, ncol)
  terra::writeRaster(rast(ud), filename = paste0(basePath,"/", folder, "/", "ud2.tif"), overwrite=TRUE)
  }
```
```{r generate UD graphs}
# get base path
basePath <- "./data/output/domain-100-by-100"
# get folder names in base path
#folders <- c( "test-3-6")
folders <- list.files(path = basePath, recursive = FALSE)
folders <- folders[grepl("d", folders)]
nfolders <- length(folders)
for(f in seq_along(folders)){
  folder <- folders[f]
  idString <- strsplit(x = folder, split =  "-")[[1]]
  simIter <- idString[1] # simIter
  theta <- as.numeric(idString[2]) # habitat preference
  smoothingFactor <- as.numeric(idString[3]) # rho
  #movePen <- as.numeric(idString[4]) / 100 # mu 
  ud <- terra::rast(paste0(basePath, "/", folder, "/", "ud.tif"))
  land <- terra::rast(paste0(basePath, "/", folder, "/", "ls.tif"))
  out <- data.frame(land = terra::values(land), ud = log(terra::values(ud)/1e8))
  names(out) <- c("land", "ud")
  p <- ggplot(out, aes(x = land, y = ud)) + geom_point() +   geom_smooth(method = "lm", se = FALSE, color = "blue") +  # line of best fit
    stat_poly_eq(
        formula = y ~ x,
        aes(label = paste(..eq.label.., sep = "~~~")),
        parse = TRUE,
        label.x.npc = "left", label.y.npc = 0.95
    ) +
    theme_minimal() +
    ggtitle( label = paste0('\u03C1', " = ", smoothingFactor, ";", " \u0398", " = ", theta))
  ggsave(paste0(basePath, "/", folder, "/", "ud-plot.png"), p)
}

```
```{r zip everything}

```


